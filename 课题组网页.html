import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged,
  signOut,
  User 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  query, 
  serverTimestamp
} from 'firebase/firestore';
import { 
  BookOpen, 
  Users, 
  FlaskConical, 
  Menu, 
  X, 
  Plus, 
  Trash2, 
  ExternalLink, 
  Lock, 
  LogOut, 
  Search,
  FileText,
  Award,
  GraduationCap,
  Briefcase,
  Globe,
  Lightbulb,
  MapPin,
  Mail,
  ChevronDown,
  ChevronUp,
  UserCheck,
  Filter
} from 'lucide-react';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Types ---
type ResearchField = 'chassis' | 'energy' | 'intelligent' | 'other';

interface Paper {
  id: string;
  title: string;
  authors: string;
  journal: string;
  year: string;
  url?: string;
  type: 'paper' | 'patent';
  field: ResearchField; // Added field for categorization
  tag?: string;
  createdAt?: any;
}

interface Student {
  id: number;
  name: string;
  gender: string;
  type: string;
  startYear: string;
  endYear: string;
  thesis: string;
  isGraduated: boolean;
}

// --- CONSTANTS & MOCK DATA ---

// 1. Research Fields Definition
const RESEARCH_FIELDS: {id: ResearchField, label: string, color: string}[] = [
  { id: 'chassis', label: '智能底盘与动力学控制', color: 'bg-blue-100 text-blue-800' },
  { id: 'energy', label: '能量管理与驱动控制', color: 'bg-green-100 text-green-800' },
  { id: 'intelligent', label: '智能驾驶与运动规划', color: 'bg-purple-100 text-purple-800' },
  { id: 'other', label: '其他/综合', color: 'bg-slate-100 text-slate-800' },
];

// 2. PI Data
const PI_INFO = {
  basic: {
    name: "王军年",
    title: "教授 / 博导",
    roles: [
      "吉林大学唐敖庆英才教授",
      "汽车工程系主任",
      "汽车基础实验教学中心主任",
      "汽车研究所所长",
      "吉林省拔尖创新人才"
    ],
    email: "wjn@jlu.edu.cn",
    address: "吉林省长春市人民大街5988号 吉林大学南岭校区汽车工程大楼505",
    intro: "1981年生，工学博士。吉林省中青年科技创新创业领军人才（团队），吉林大学励新计划优秀青年教师（精英阶段）。主要从事电动汽车动力传动与智能四驱技术、能量管理与控制等领域的研究。"
  },
  education: [
    { time: "2009", degree: "工学博士", major: "车辆工程", school: "吉林大学汽车工程学院" },
    { time: "2006", degree: "工学硕士", major: "机械电子工程", school: "吉林大学机械科学与工程学院" },
    { time: "2003", degree: "工学学士", major: "机械制造及自动化", school: "吉林大学机械科学与工程学院" }
  ],
  work: [
    { time: "2016.10 - 至今", role: "教授", org: "吉林大学汽车工程学院" },
    { time: "2015.09 - 2016.09", role: "公派访问学者", org: "美国加州大学戴维斯分校" },
    { time: "2011.10 - 2016.09", role: "副教授", org: "吉林大学汽车工程学院" },
    { time: "2009.07 - 2011.09", role: "讲师", org: "吉林大学汽车工程学院" }
  ],
  research: [
    { title: "电动汽车动力传动与智能四驱技术", desc: "研究高性能动力系统多能源综合能量管理与控制技术。", icon: <FlaskConical className="w-6 h-6 text-blue-600" /> },
    { title: "电动汽车能量管理与驱/制动控制", desc: "面向高效节能的电动四驱汽车驱动能量优化管理策略开发。", icon: <Lightbulb className="w-6 h-6 text-yellow-600" /> },
    { title: "电动底盘集成设计与智行运动规控", desc: "智能电动汽车差动协同式主动前轮转向及底盘集成控制关键问题研究。", icon: <Globe className="w-6 h-6 text-green-600" /> },
  ],
  awards: [
    "吉林省科技进步一等奖",
    "中国汽车工业科技进步三等奖",
    "吉林省自然科学学术成果二等奖",
    "中国汽车工程学会成立60周年先进学会工作者",
    "长春市第一届“创新杯”高价值专利大赛银奖",
    "吉林大学“教书育人”先进个人奖"
  ],
  projects: [
    "国家自然科学基金面上项目：电动汽车转矩定向分配驱动系统结构拓扑优化、动态鲁棒控制与整车应用研究",
    "国家自然科学基金面上项目：四轮独立驱动电动汽车转弯节能与转向机动转矩定向分配关键技术研究",
    "国家自然科学基金青年基金项目：具备差动助力转向功能的电动轮独立驱动汽车转矩协调控制机理研究",
    "吉林省重大科技专项：高性能动力系统多能源综合能量管理与控制技术研究",
    "科技部国际合作项目子项：制动能量回收系统的电机电池协调控制装置研究"
  ]
};

// 3. Papers Data (Categorized by Field)
const INITIAL_PAPERS: Paper[] = [
  // Intelligent Chassis & Dynamics (chassis)
  { id: 'p1', type: 'paper', field: 'chassis', year: '2024', title: 'Coordinated Steering Stability Control Combining DDAS and AFS', authors: 'Junnian Wang, Chunlin Zhang, et al.', journal: 'IEEE TTE', tag: 'SCI一区' },
  { id: 'p3', type: 'paper', field: 'chassis', year: '2023', title: 'Differential Drive Collaborative Steering Control', authors: 'Junnian Wang, Zhenyu Wang, et al.', journal: 'IEEE TTE', tag: 'SCI一区' },
  { id: 'p8', type: 'paper', field: 'chassis', year: '2018', title: 'Coordination control of differential drive assist steering and stability', authors: 'Junnian Wang, Zheng Luo, et al.', journal: 'IEEE TVT', tag: 'SCI二区' },
  { id: 'p10', type: 'paper', field: 'chassis', year: '2011', title: 'Independent wheel torque control of 4WD electric vehicle', authors: 'Junnian Wang, Qingnian Wang, et al.', journal: 'MECHATRONICS', tag: 'SCI二区' },
  
  // Energy Management (energy)
  { id: 'p2', type: 'paper', field: 'energy', year: '2023', title: 'Bond graph modeling and torque control based on RBF-SMC', authors: 'Shoulin Gao, Junnian Wang*, et al.', journal: 'IEEE TVT', tag: 'SCI二区' },
  { id: 'p4', type: 'paper', field: 'energy', year: '2023', title: 'Wheel torque distribution control strategy for energy efficient', authors: 'Shoulin Gao, Junnian Wang*, et al.', journal: 'IEEE TTE', tag: 'SCI一区' },
  { id: 'p5', type: 'paper', field: 'energy', year: '2023', title: 'Drive-cycle Based Configuration Design and Energy Efficiency Analysis', authors: 'Junnian Wang, Chunlin Zhang*, et al.', journal: 'IEEE TTE', tag: 'SCI一区' },
  { id: 'p6', type: 'paper', field: 'energy', year: '2024', title: 'Torque Vectoring and Multi-Mode Driving of Electric Vehicles', authors: 'Junnian WANG, Zhenhao ZHANG, et al.', journal: 'AUTO INNOV', tag: 'ESCI' },
  { id: 'p9', type: 'paper', field: 'energy', year: '2015', title: 'Predictive-model-based dynamic coordination control strategy', authors: 'Xiaohua Zeng, ..., Junnian Wang*, et al.', journal: 'MSSP', tag: 'SCI一区' },
  { id: 'p12', type: 'paper', field: 'energy', year: '2021', title: 'Wheel torque distribution optimization for energy efficient driving', authors: 'Junnian Wang, et al.', journal: 'CEP', tag: 'SCI二区' },

  // Intelligent Driving (intelligent)
  { id: 'p11', type: 'paper', field: 'intelligent', year: '2023', title: 'Automatic parking trajectory planning based on random sampling', authors: 'Junnian WANG, et al.', journal: 'J FRANKLIN I', tag: 'SCI二区' },

  // Patents (Mapped to fields best effort)
  { id: 'pat1', type: 'patent', field: 'chassis', year: '2016', title: 'Automobile Active Steering System with Cycloidal-Pin Wheel Mechanism', authors: 'Junnian Wang, et al.', journal: 'US Patent: US9,415,797 B2', tag: '美国专利' },
  { id: 'pat2', type: 'patent', field: 'energy', year: '2018', title: 'Drive Axle of Electric Distribution Torque', authors: 'Junnian Wang, et al.', journal: 'US Patent: US10,065,489B2', tag: '美国专利' },
  { id: 'pat7', type: 'patent', field: 'intelligent', year: '2020', title: '基于车间通信的汽车交通路口辅助通行系统及其控制方法', authors: '王军年，罗睿等', journal: '中国专利', tag: '中国发明专利' },
];

// 4. Student Data (Parsed from your list)
const STUDENT_DATA_RAW = [
  ["1","闫佳伟","男","学术硕士","2012","2015.06","汽车智能驻车与辅助起步控制系统研究"],
  ["2","孙文","女","协助指导","2012","2018.06","四轮独立驱动电动汽车最小转弯能耗转矩优化控制研究"],
  ["3","孙杰","男","协助指导","2012","2015.06","基于逻辑门限值的四轮独立驱动汽车牵引力控制研究"],
  ["4","张运昌","男","协助指导","2012","2015.06","纯电动轿车双电机耦合驱动系统构型与控制策略研究"],
  ["5","魏武","男","学术硕士","2013","2016.06","电动轮驱动铰接转向差动协同转向控制"],
  ["6","李修森","男","学术硕士","2013","2016.06","电动轮驱动汽车差动助力转向鲁棒控制研究"],
  ["7","刘鹏","男","专业硕士","2014","2017.06","电动轮驱动汽车双横臂悬架运动学特性分析及优化"],
  ["8","李卓","男","协助指导","2014","2017.06","乙醇水蒸气微波等离子体重整制氢实验研究"],
  ["9","张垚","男","学术硕士","2015","2018.06","运动型电动轮驱动汽车转矩定向分配控制技术研究"],
  ["10","孙娜娜","女","学术硕士","2015","2018.06","转矩定向分配后轮独立驱动电动汽车转弯节能控制研究"],
  ["11","王岩","男","学术硕士","2015","2018.06","四轮独立驱动电动车辆驱动能量管理"],
  ["12","马忠伟","女","工程硕士","2015","2020.09","某自主品牌汽车新产品开发质量管理方法研究"],
  ["13","罗正","男","学术硕士","2016","2019.06","电动轮驱动汽车差动助力转向与稳定性协调控制"],
  ["14","杨斌","男","学术硕士","2016","2019.06","基于键合图法的转矩定向分配电动驱动桥建模与控制"],
  ["16","郭德东","男","学术硕士","2017","2020.06","电动轮驱动汽车差动协同主动转向系统研究"],
  ["17","王凯","男","学术硕士","2017","2020.06","带有TV驱动桥的电动汽车转弯节能动力学控制"],
  ["18","刘培祥","男","专业硕士","2017","2020.06","四轮独立驱动铰接车辆转向节能控制"],
  ["19","颜庭旭","男","学术硕士","2018","2021.06","电动轮驱动汽车极限工况下轨迹跟随控制"],
  ["20","倪健土","男","学术硕士","2018","2021.06","新型双电机耦合驱动系统参数匹配和模式切换控制"],
  ["21","于田雨","女","学术硕士","2018","2021.06","双电机四驱汽车动力系统匹配设计和能量管理策略研究"],
  ["22","王宪东","男","专业硕士","2018","2021.06","基于质量和坡度估计的电动汽车全工况自适应车速控制"],
  ["23","孟祥哲","男","专业硕士","2018","2021.06","基于随机采样与优化的自动泊车路径规划与跟踪控制算法研究"],
  ["24","孟令帅","男","学术硕士","2018","2021.06","汽车电液悬架主动抗侧倾控制性能研究"],
  ["25","吴桐","男","协助指导","2018","2022.06","商用车电控机械制动器结构与制动力控制策略研究"],
  ["26","高守林","男","学术博士","2019","2023.06","电动汽车转矩定向分配驱动桥系统动态特性分析与控制技术研究"],
  ["27","盖际羽","男","专业硕士","2019","2022.06","纯电动汽车无动力中断两挡变速驱动桥设计与换挡控制"],
  ["28","吕斯文","女","专业硕士","2019","2022.06","基于能耗优化的四驱电动汽车能量管理策略研究"],
  ["29","朱可夫","男","学术硕士","2019","2022.06","双模式后轮主动转向系统设计与控制的研究"],
  ["30","强越","女","学术硕士","2019","2023.06","轮毂电机两挡变速驱动系统换挡策略研究"],
  ["31","徐蒙","男","专业硕士","2019","2022.06","电动转矩定向分配驱动桥虚拟样机与台架试验"],
  ["32","滕飞","男","学术硕士","2019","2022.06","紧急避让工况智能车轨迹跟踪控制算法研究"],
  ["33","王欣志","男","专业硕士","2019","2022.06","商用车自动紧急避障横摆稳定性控制策略研究"],
  ["34","周子栋","男","本硕博连读","2020","",""],
  ["35","管畅洋","男","学术硕士","2020","2023.06","面向整车全工况经济性改善的双电机耦合TV驱动系统研究"],
  ["36","李佳俊","男","学术硕士","2020","2023.06","基于四轮转向的自动泊车系统路径规划与跟踪算法研究"],
  ["37","朱振华","男","专业硕士","2020","2023.06","独立驱动制动电动汽车制动能量回收优化控制策略研究"],
  ["38","程川泰","男","学术硕士","2020","2023.06","面向智能座舱的驾驶员尺度识别与舒适坐姿研究"],
  ["39","范瑞浩","男","学术硕士","2020","2023.06","多模式线控转向执行系统设计与控制策略研究"],
  ["40","刘哲","男","本直博","2021","","基于AFS和TVC集成控制的MPC极限漂移自动控制"],
  ["41","张春林","男","学术硕士","2021","2024.06","双电机四驱电动汽车弯道横纵向动力学耦合控制"],
  ["42","郭大畅","男","学术硕士","2021","2024.06","三电机四驱电动汽车多模式驱动与换挡控制研究"],
  ["43","付东旭","男","学术硕士","2021","2024.06","集成式双模后轮主动转向系统执行与应用控制研究"],
  ["44","张振浩","男","学术硕士","2021","2024.06","前后轴独立驱动电动四驱汽车驱动防滑控制研究"],
  ["45","王振宇","男","专业硕士","2021","2024.06","电动四驱线控转向汽车自动避障差动容错控制研究"],
  ["47","曹宇靖","男","学术硕士","2022","2025.06","车辆自动紧急驱制动策略研究"],
  ["48","郑天慧","女","学术硕士","2022","2025.06","基于分层拓扑图的E-TVD数字化建模与构型评价"],
  ["49","赵梦圆","女","学术硕士","2022","2025.06","两挡变速双电机独立驱动系统协同换挡控制研究"],
  ["50","李中豪","男","专业硕士","2022","2025.06","基于深度强化学习的自动驾驶汽车碰撞后主动安全研究"],
  ["51","许汇鑫","男","学术硕士","2022","2025.06","考虑功能安全的线控转向系统故障诊断与容错控制策略研究"],
  ["52","杨久龙","男","专业硕士","2022","2025.06","具备障碍物轨迹预测的四轮转向汽车代客泊车路径规划研究"]
];

const STUDENT_DATA: Student[] = STUDENT_DATA_RAW.map(row => ({
  id: parseInt(row[0]),
  name: row[1],
  gender: row[2],
  type: row[3],
  startYear: row[4],
  endYear: row[5],
  thesis: row[6] || "（在研）",
  isGraduated: !!row[5] && parseInt(row[5].split('.')[0]) <= new Date().getFullYear()
}));


// --- Components ---

// 1. Navbar
const Navbar = ({ 
  view, 
  setView, 
  user, 
  handleLogin 
}: { 
  view: string; 
  setView: (v: string) => void; 
  user: User | null; 
  handleLogin: () => void 
}) => {
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const NavItem = ({ target, label, icon: Icon }: any) => (
    <button
      onClick={() => { setView(target); setIsMenuOpen(false); }}
      className={`flex items-center space-x-2 px-3 py-2 rounded-md transition-colors ${
        view === target ? 'bg-blue-50 text-blue-700 font-medium' : 'text-slate-600 hover:bg-slate-50'
      }`}
    >
      {Icon && <Icon className="w-4 h-4" />}
      <span>{label}</span>
    </button>
  );

  return (
    <nav className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16">
          <div className="flex items-center cursor-pointer" onClick={() => setView('home')}>
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-2">
              <FlaskConical className="text-white w-5 h-5" />
            </div>
            <span className="font-bold text-xl text-slate-800 hidden sm:inline">智能计算实验室</span>
            <span className="font-bold text-xl text-slate-800 sm:hidden">NextGen Lab</span>
          </div>

          <div className="hidden md:flex items-center space-x-1">
            <NavItem target="home" label="主页" />
            <NavItem target="profile" label="PI简介" icon={Users} />
            <NavItem target="talent" label="人才培养" icon={GraduationCap} />
            <NavItem target="publications" label="学术成果" icon={BookOpen} />
            
            {user ? (
              <>
                <div className="h-6 w-px bg-slate-300 mx-2"></div>
                <NavItem target="admin" label="后台" icon={Lock} />
                <button 
                  onClick={() => signOut(auth)}
                  className="flex items-center space-x-2 px-3 py-2 text-red-600 hover:bg-red-50 rounded-md ml-1"
                >
                  <LogOut className="w-4 h-4" />
                </button>
              </>
            ) : (
              <button 
                onClick={handleLogin}
                className="flex items-center space-x-2 px-3 py-2 text-slate-400 hover:text-blue-600 ml-2"
                title="管理员登录"
              >
                <Lock className="w-4 h-4" />
              </button>
            )}
          </div>

          <div className="flex items-center md:hidden">
            <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-slate-600 p-2">
              {isMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
            </button>
          </div>
        </div>
      </div>

      {isMenuOpen && (
        <div className="md:hidden bg-white border-t border-slate-100 p-2 space-y-1">
          <NavItem target="home" label="主页" />
          <NavItem target="profile" label="负责人介绍" />
          <NavItem target="talent" label="人才培养" />
          <NavItem target="publications" label="学术成果" />
          {user ? (
            <NavItem target="admin" label="管理后台" icon={Lock} />
          ) : (
            <button 
              onClick={() => { handleLogin(); setIsMenuOpen(false); }}
              className="w-full text-left flex items-center space-x-2 px-4 py-2 text-slate-600"
            >
              <Lock className="w-4 h-4" />
              <span>管理员登录</span>
            </button>
          )}
        </div>
      )}
    </nav>
  );
};

// 2. Talent View (New)
const TalentView = () => {
  const [filterType, setFilterType] = useState('all');
  const [showGraduated, setShowGraduated] = useState('all'); // all, current, graduated

  const filteredStudents = useMemo(() => {
    return STUDENT_DATA.filter(student => {
      const typeMatch = filterType === 'all' || student.type.includes(filterType);
      const gradMatch = showGraduated === 'all' 
        ? true 
        : showGraduated === 'graduated' 
          ? student.isGraduated 
          : !student.isGraduated;
      return typeMatch && gradMatch;
    });
  }, [filterType, showGraduated]);

  const stats = {
    total: STUDENT_DATA.length,
    phd: STUDENT_DATA.filter(s => s.type.includes('博')).length,
    master: STUDENT_DATA.filter(s => s.type.includes('硕')).length,
    graduated: STUDENT_DATA.filter(s => s.isGraduated).length
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-12 animate-fade-in min-h-screen">
      <div className="mb-10 text-center">
        <h2 className="text-3xl font-bold text-slate-900">人才培养</h2>
        <p className="text-slate-500 mt-2 max-w-2xl mx-auto">
          课题组累计培养研究生 {stats.total} 人，其中博士 {stats.phd} 人，硕士 {stats.master} 人。
          已毕业 {stats.graduated} 人，均在高校或汽车行业重点企业任职。
        </p>
      </div>

      {/* Filters */}
      <div className="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-6 gap-4">
        <div className="flex items-center space-x-2">
          <Filter className="w-5 h-5 text-slate-400" />
          <span className="font-bold text-slate-700">筛选:</span>
        </div>
        
        <div className="flex flex-wrap gap-4">
           <select 
             className="bg-slate-50 border border-slate-300 text-slate-700 rounded-md px-3 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none"
             value={filterType}
             onChange={(e) => setFilterType(e.target.value)}
           >
             <option value="all">全部学位类型</option>
             <option value="博">博士</option>
             <option value="硕">硕士</option>
           </select>

           <div className="flex bg-slate-100 rounded-md p-1">
             <button 
               onClick={() => setShowGraduated('all')}
               className={`px-4 py-1 rounded text-sm font-medium transition-all ${showGraduated === 'all' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
             >
               全部
             </button>
             <button 
               onClick={() => setShowGraduated('current')}
               className={`px-4 py-1 rounded text-sm font-medium transition-all ${showGraduated === 'current' ? 'bg-white text-green-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
             >
               在读
             </button>
             <button 
               onClick={() => setShowGraduated('graduated')}
               className={`px-4 py-1 rounded text-sm font-medium transition-all ${showGraduated === 'graduated' ? 'bg-white text-slate-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
             >
               已毕业
             </button>
           </div>
        </div>
      </div>

      {/* Table */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-slate-200">
            <thead className="bg-slate-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">姓名/类别</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">时间</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">学位论文题目</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">状态</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-slate-200">
              {filteredStudents.map((student) => (
                <tr key={student.id} className="hover:bg-slate-50 transition-colors">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      <div className={`flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center font-bold text-white ${student.gender === '男' ? 'bg-blue-400' : 'bg-pink-400'}`}>
                        {student.name[0]}
                      </div>
                      <div className="ml-4">
                        <div className="text-sm font-bold text-slate-900">{student.name}</div>
                        <div className="text-xs text-slate-500">{student.type}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm text-slate-900">{student.startYear} 入学</div>
                    <div className="text-xs text-slate-500">{student.endYear || '在读'}</div>
                  </td>
                  <td className="px-6 py-4">
                    <div className="text-sm text-slate-700 font-medium line-clamp-2" title={student.thesis}>
                      {student.thesis}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    {student.isGraduated ? (
                      <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-slate-100 text-slate-600">
                        已毕业
                      </span>
                    ) : (
                      <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        在读
                      </span>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {filteredStudents.length === 0 && (
          <div className="p-12 text-center text-slate-500">
            没有找到符合条件的学生记录
          </div>
        )}
      </div>
    </div>
  );
};

// 3. Publications View (Updated with Categories)
const PublicationsView = ({ papers, loading }: { papers: Paper[], loading: boolean }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [activeTab, setActiveTab] = useState<'paper' | 'patent'>('paper');
  const [activeField, setActiveField] = useState<ResearchField | 'all'>('all');
  
  const filteredItems = papers.filter(p => {
    const matchesTab = p.type === activeTab;
    const matchesField = activeField === 'all' || p.field === activeField;
    const matchesSearch = 
      p.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      p.authors.toLowerCase().includes(searchTerm.toLowerCase()) ||
      p.year.toString().includes(searchTerm);
    return matchesTab && matchesField && matchesSearch;
  });

  return (
    <div className="max-w-6xl mx-auto px-4 py-12 min-h-screen">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
           <h2 className="text-3xl font-bold text-slate-900">学术成果</h2>
           <p className="text-slate-500 mt-2">按领域分类展示论文与专利</p>
        </div>
        <div className="relative w-full md:w-auto">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
          <input 
            type="text" 
            placeholder={`搜索${activeTab === 'paper' ? '论文' : '专利'}...`}
            className="pl-10 pr-4 py-2 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-72 shadow-sm"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
      </div>

      {/* Main Tabs (Paper vs Patent) */}
      <div className="flex space-x-6 border-b border-slate-200 mb-6">
        <button
          onClick={() => setActiveTab('paper')}
          className={`pb-3 px-2 text-lg font-medium transition-colors border-b-2 ${
            activeTab === 'paper' 
              ? 'border-blue-600 text-blue-600' 
              : 'border-transparent text-slate-500 hover:text-slate-700'
          }`}
        >
          学术论文
        </button>
        <button
          onClick={() => setActiveTab('patent')}
          className={`pb-3 px-2 text-lg font-medium transition-colors border-b-2 ${
            activeTab === 'patent' 
              ? 'border-blue-600 text-blue-600' 
              : 'border-transparent text-slate-500 hover:text-slate-700'
          }`}
        >
          授权专利
        </button>
      </div>

      {/* Field Filters */}
      <div className="flex flex-wrap gap-2 mb-8">
        <button
          onClick={() => setActiveField('all')}
          className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors border ${
            activeField === 'all' 
              ? 'bg-slate-800 text-white border-slate-800' 
              : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'
          }`}
        >
          全部领域
        </button>
        {RESEARCH_FIELDS.slice(0, 3).map(field => (
          <button
            key={field.id}
            onClick={() => setActiveField(field.id)}
            className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors border flex items-center gap-1 ${
              activeField === field.id
                ? 'bg-blue-600 text-white border-blue-600'
                : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'
            }`}
          >
            {field.label}
          </button>
        ))}
      </div>

      {loading ? (
        <div className="flex justify-center py-20">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      ) : filteredItems.length === 0 ? (
        <div className="text-center py-20 bg-slate-50 rounded-lg border border-dashed border-slate-300">
          <FileText className="w-12 h-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">该分类下暂无记录</p>
        </div>
      ) : (
        <div className="space-y-4">
          {filteredItems.map((item) => {
            const fieldInfo = RESEARCH_FIELDS.find(f => f.id === item.field);
            return (
              <div key={item.id} className="bg-white p-6 rounded-lg border border-slate-200 hover:border-blue-300 hover:shadow-md transition-all group relative">
                <div className="flex justify-between items-start gap-4">
                  <div className="hidden sm:block mt-1">
                    {item.type === 'paper' ? <FileText className="w-6 h-6 text-blue-200 group-hover:text-blue-500 transition-colors"/> : <Award className="w-6 h-6 text-yellow-200 group-hover:text-yellow-500 transition-colors"/>}
                  </div>
                  
                  <div className="flex-1">
                    <div className="flex flex-wrap gap-2 mb-2">
                       <span className={`px-2 py-0.5 rounded text-xs font-bold border ${item.type === 'paper' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'}`}>
                         {item.year}
                       </span>
                       {fieldInfo && (
                         <span className={`px-2 py-0.5 rounded text-xs font-bold ${fieldInfo.color}`}>
                           {fieldInfo.label}
                         </span>
                       )}
                       {item.tag && (
                         <span className="px-2 py-0.5 rounded text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200">
                           {item.tag}
                         </span>
                       )}
                    </div>
                    
                    <h3 className="text-lg font-bold text-slate-900 leading-snug group-hover:text-blue-700 transition-colors">
                      {item.title}
                    </h3>
                    <p className="text-slate-600 mt-2 text-sm leading-relaxed">{item.authors}</p>
                    <p className="text-slate-500 mt-1 text-sm italic font-serif border-l-2 border-slate-200 pl-2">
                      {item.journal}
                    </p>
                  </div>

                  {item.url && (
                    <a 
                      href={item.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors flex-shrink-0"
                      title="查看原文"
                    >
                      <ExternalLink className="w-5 h-5" />
                    </a>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
};

// 4. Section Expander Component (for Profile)
const Section = ({ title, icon: Icon, children, defaultOpen = false }: any) => {
  const [isOpen, setIsOpen] = useState(defaultOpen);
  return (
    <div className="border border-slate-200 rounded-lg bg-white overflow-hidden mb-4 shadow-sm">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 transition-colors"
      >
        <div className="flex items-center space-x-3 text-slate-800 font-bold text-lg">
          {Icon && <Icon className="w-5 h-5 text-blue-600" />}
          <span>{title}</span>
        </div>
        {isOpen ? <ChevronUp className="w-5 h-5 text-slate-500" /> : <ChevronDown className="w-5 h-5 text-slate-500" />}
      </button>
      {isOpen && <div className="p-6 border-t border-slate-100">{children}</div>}
    </div>
  );
};

// 5. Profile View
const ProfileView = () => (
  <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-in">
    {/* Profile Header */}
    <div className="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row gap-8 items-start">
      <div className="w-32 h-32 md:w-48 md:h-48 bg-slate-100 rounded-full flex-shrink-0 flex items-center justify-center border-4 border-blue-50 overflow-hidden">
        <Users className="w-20 h-20 text-slate-300" /> 
        {/* Replace with real image if available */}
      </div>
      <div className="flex-1">
        <h1 className="text-3xl font-bold text-slate-900 mb-2">{PI_INFO.basic.name}</h1>
        <p className="text-blue-600 font-medium text-lg mb-4">{PI_INFO.basic.title}</p>
        <div className="flex flex-wrap gap-2 mb-4">
          {PI_INFO.basic.roles.map((role, idx) => (
            <span key={idx} className="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-medium border border-slate-200">
              {role}
            </span>
          ))}
        </div>
        <p className="text-slate-600 leading-relaxed mb-6">{PI_INFO.basic.intro}</p>
        <div className="space-y-2 text-sm text-slate-500">
           <div className="flex items-center gap-2">
             <MapPin className="w-4 h-4" />
             <span>{PI_INFO.basic.address}</span>
           </div>
           <div className="flex items-center gap-2">
             <Mail className="w-4 h-4" />
             <a href={`mailto:${PI_INFO.basic.email}`} className="hover:text-blue-600 transition-colors">{PI_INFO.basic.email}</a>
           </div>
        </div>
      </div>
    </div>

    {/* Details Sections */}
    <Section title="研究方向" icon={FlaskConical} defaultOpen={true}>
      <div className="grid gap-6 md:grid-cols-1">
        {PI_INFO.research.map((item, idx) => (
          <div key={idx} className="flex gap-4 items-start">
            <div className="bg-blue-50 p-3 rounded-lg flex-shrink-0">
              {item.icon}
            </div>
            <div>
              <h3 className="font-bold text-slate-900 text-lg">{item.title}</h3>
              <p className="text-slate-600 mt-1">{item.desc}</p>
            </div>
          </div>
        ))}
      </div>
    </Section>

    <Section title="教育与工作经历" icon={GraduationCap}>
      <div className="space-y-6">
        <div>
          <h3 className="font-bold text-slate-800 mb-3 border-l-4 border-blue-600 pl-3">工作经历</h3>
          <ul className="space-y-3">
            {PI_INFO.work.map((job, idx) => (
              <li key={idx} className="flex flex-col sm:flex-row sm:justify-between sm:items-baseline text-slate-600 bg-slate-50 p-3 rounded">
                <span className="font-medium text-slate-900">{job.role} — {job.org}</span>
                <span className="text-sm text-slate-500 font-mono mt-1 sm:mt-0">{job.time}</span>
              </li>
            ))}
          </ul>
        </div>
        <div>
          <h3 className="font-bold text-slate-800 mb-3 border-l-4 border-green-600 pl-3">教育经历</h3>
          <ul className="space-y-3">
            {PI_INFO.education.map((edu, idx) => (
              <li key={idx} className="flex flex-col sm:flex-row sm:justify-between sm:items-baseline text-slate-600 bg-slate-50 p-3 rounded">
                 <span>
                    <strong className="text-slate-900">{edu.school}</strong> {edu.major} <span className="text-blue-600">({edu.degree})</span>
                 </span>
                <span className="text-sm text-slate-500 font-mono mt-1 sm:mt-0">{edu.time}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </Section>

    <Section title="科研与教改项目" icon={Briefcase}>
      <div className="space-y-2">
        {PI_INFO.projects.map((proj, idx) => (
          <div key={idx} className="flex gap-3 items-start p-2 hover:bg-slate-50 rounded transition-colors">
            <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-0.5 rounded mt-1 flex-shrink-0">项目</span>
            <span className="text-slate-700 leading-relaxed">{proj}</span>
          </div>
        ))}
        <p className="text-sm text-slate-400 mt-4 italic">* 另主持多项企业横向合作课题（一汽、宇通、北奔重汽等）。</p>
      </div>
    </Section>

    <Section title="荣誉与奖项" icon={Award}>
      <ul className="grid gap-2 sm:grid-cols-2">
        {PI_INFO.awards.map((award, idx) => (
          <li key={idx} className="flex items-center gap-2 p-3 bg-yellow-50/50 border border-yellow-100 rounded text-slate-700">
             <Award className="w-4 h-4 text-yellow-500 flex-shrink-0" />
             <span>{award}</span>
          </li>
        ))}
      </ul>
    </Section>
  </div>
);

// 6. Home View
const HomeView = ({ setView }: { setView: (v: string) => void }) => (
  <div className="animate-fade-in">
    {/* Hero Section */}
    <div className="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white py-24 px-4 relative overflow-hidden">
      <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1485827404703-89b55fcc595e?auto=format&fit=crop&q=80')] opacity-10 bg-cover bg-center"></div>
      <div className="max-w-5xl mx-auto text-center relative z-10">
        <h1 className="text-4xl md:text-6xl font-bold mb-6 tracking-tight">
          电动化与智能化底盘技术
        </h1>
        <p className="text-xl md:text-2xl text-slate-300 mb-10 font-light max-w-3xl mx-auto">
          王军年教授课题组 — 专注于电动汽车动力传动、智能四驱与能量管理的前沿研究。
        </p>
        <div className="flex justify-center gap-4 flex-wrap">
          <button 
            onClick={() => setView('publications')}
            className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-semibold transition-all transform hover:scale-105 shadow-lg flex items-center gap-2"
          >
            <BookOpen className="w-5 h-5" />
            浏览成果
          </button>
          <button 
            onClick={() => setView('talent')}
            className="px-8 py-3 bg-white/10 backdrop-blur-sm border border-white/30 hover:bg-white/20 text-white rounded-full font-semibold transition-all flex items-center gap-2"
          >
            <Users className="w-5 h-5" />
            人才培养
          </button>
        </div>
      </div>
    </div>

    {/* Research Areas */}
    <div className="py-20 bg-slate-50">
      <div className="max-w-7xl mx-auto px-4">
        <div className="text-center mb-16">
          <h2 className="text-3xl font-bold text-slate-900">核心研究方向</h2>
          <div className="w-20 h-1 bg-blue-600 mx-auto mt-4"></div>
        </div>
        <div className="grid md:grid-cols-3 gap-8">
          {PI_INFO.research.map((area, idx) => (
            <div key={idx} className="bg-white p-8 rounded-xl shadow-sm hover:shadow-lg transition-all border-t-4 border-blue-600">
              <div className="w-14 h-14 bg-blue-50 rounded-full flex items-center justify-center mb-6 mx-auto">
                {area.icon}
              </div>
              <h3 className="text-xl font-bold text-slate-800 mb-3 text-center">{area.title}</h3>
              <p className="text-slate-600 leading-relaxed text-center">{area.desc}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
);

// 7. Admin Dashboard
const AdminDashboard = ({ 
  papers, 
  loading, 
  onAdd, 
  onDelete 
}: { 
  papers: Paper[], 
  loading: boolean, 
  onAdd: (p: any) => void,
  onDelete: (id: string) => void
}) => {
  const [newPaper, setNewPaper] = useState({
    title: '',
    authors: '',
    journal: '',
    year: new Date().getFullYear().toString(),
    url: '',
    type: 'paper',
    field: 'chassis',
    tag: ''
  });
  const [isFormOpen, setIsFormOpen] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onAdd(newPaper);
    setNewPaper({ title: '', authors: '', journal: '', year: new Date().getFullYear().toString(), url: '', type: 'paper', field: 'chassis', tag: '' });
    setIsFormOpen(false);
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-10 bg-slate-50 min-h-screen">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">后台管理系统</h2>
          <p className="text-slate-500">管理课题组的文献与专利数据库</p>
        </div>
        <button 
          onClick={() => setIsFormOpen(true)}
          className="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
        >
          <Plus className="w-4 h-4" />
          <span>添加成果</span>
        </button>
      </div>

      {/* Add Modal */}
      {isFormOpen && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in-up max-h-[90vh] overflow-y-auto">
            <div className="bg-slate-100 px-6 py-4 border-b border-slate-200 flex justify-between items-center sticky top-0">
              <h3 className="font-bold text-slate-800">录入新成果</h3>
              <button onClick={() => setIsFormOpen(false)} className="text-slate-500 hover:text-red-500">
                <X className="w-5 h-5" />
              </button>
            </div>
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">类型</label>
                   <select 
                      className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={newPaper.type}
                      onChange={e => setNewPaper({...newPaper, type: e.target.value as any})}
                   >
                     <option value="paper">学术论文</option>
                     <option value="patent">发明专利</option>
                   </select>
                </div>
                <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">所属领域</label>
                   <select 
                      className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={newPaper.field}
                      onChange={e => setNewPaper({...newPaper, field: e.target.value as any})}
                   >
                     {RESEARCH_FIELDS.map(f => (
                       <option key={f.id} value={f.id}>{f.label}</option>
                     ))}
                   </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">标题</label>
                <input 
                  required
                  className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={newPaper.title}
                  onChange={e => setNewPaper({...newPaper, title: e.target.value})}
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">年份</label>
                  <input 
                    type="number"
                    required
                    className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={newPaper.year}
                    onChange={e => setNewPaper({...newPaper, year: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">标签 (选填)</label>
                  <input 
                    className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={newPaper.tag}
                    onChange={e => setNewPaper({...newPaper, tag: e.target.value})}
                    placeholder="例如: SCI一区"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">作者列表</label>
                <input 
                  required
                  className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={newPaper.authors}
                  onChange={e => setNewPaper({...newPaper, authors: e.target.value})}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">{newPaper.type === 'paper' ? '期刊/会议' : '专利号/国家'}</label>
                <input 
                  required
                  className="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={newPaper.journal}
                  onChange={e => setNewPaper({...newPaper, journal: e.target.value})}
                />
              </div>

              <div className="pt-4 flex justify-end space-x-3">
                <button 
                  type="button" 
                  onClick={() => setIsFormOpen(false)}
                  className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-md"
                >
                  取消
                </button>
                <button 
                  type="submit"
                  className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 shadow-sm"
                >
                  保存
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Admin List */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <table className="min-w-full divide-y divide-slate-200">
          <thead className="bg-slate-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">类型/年份</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-1/2">详情</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-slate-200">
            {papers.map((paper) => (
              <tr key={paper.id} className="hover:bg-slate-50 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                  <span className={`px-2 py-1 rounded text-xs font-bold mr-2 ${paper.type === 'paper' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}`}>
                    {paper.type === 'paper' ? '论文' : '专利'}
                  </span>
                  {paper.year}
                </td>
                <td className="px-6 py-4">
                  <div className="text-sm font-bold text-slate-900 line-clamp-1">{paper.title}</div>
                  <div className="flex items-center gap-2 mt-1">
                     <span className="text-xs text-slate-500 line-clamp-1">{paper.journal}</span>
                     {paper.field && (
                       <span className="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded">
                         {RESEARCH_FIELDS.find(f => f.id === paper.field)?.label.split('与')[0]}
                       </span>
                     )}
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <button 
                    onClick={() => onDelete(paper.id)}
                    className="text-red-400 hover:text-red-600 transition-colors p-2 hover:bg-red-50 rounded-full"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// --- Main App Component ---
export default function ResearchGroupApp() {
  const [user, setUser] = useState<User | null>(null);
  const [view, setView] = useState('home');
  const [papers, setPapers] = useState<Paper[]>([]);
  const [loading, setLoading] = useState(true);

  // Auth
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);
    return () => unsubscribeAuth();
  }, []);

  // Fetch Data
  useEffect(() => {
    if (!user) return;
    
    const q = query(
      collection(db, 'artifacts', appId, 'public', 'data', 'papers')
    );

    const unsubscribeSnapshot = onSnapshot(q, 
      (snapshot) => {
        const fetchedPapers = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })) as Paper[];
        
        const combinedPapers = [...fetchedPapers, ...INITIAL_PAPERS];
        
        // Sort: Year Descending, then type (Papers first)
        combinedPapers.sort((a, b) => {
           if (Number(b.year) !== Number(a.year)) return Number(b.year) - Number(a.year);
           return a.type === 'paper' ? -1 : 1;
        });
        
        // Remove duplicates if IDs clash (priority to DB)
        const uniquePapers = Array.from(new Map(combinedPapers.map(item => [item.id, item])).values());

        setPapers(uniquePapers);
        setLoading(false);
      },
      (error) => {
        console.error("Error fetching papers:", error);
        setPapers(INITIAL_PAPERS);
        setLoading(false);
      }
    );

    return () => unsubscribeSnapshot();
  }, [user]);

  // Handlers
  const handleLogin = async () => {
    if (!user) await signInAnonymously(auth);
    setView('admin');
  };

  const handleAddPaper = async (paperData: any) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'papers'), {
        ...paperData,
        createdAt: serverTimestamp()
      });
      alert("添加成功！");
    } catch (e) {
      console.error("Error adding paper: ", e);
      alert("添加失败");
    }
  };

  const handleDeletePaper = async (id: string) => {
    if (INITIAL_PAPERS.find(p => p.id === id)) {
      alert("演示数据不可删除 (仅数据库新增项可删除)");
      return;
    }

    if (!user) return;
    if (confirm('确定要删除这条记录吗？')) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'papers', id));
      } catch (e) {
        console.error("Error deleting: ", e);
      }
    }
  };

  return (
    <div className="font-sans text-slate-900 bg-white min-h-screen flex flex-col">
      <Navbar view={view} setView={setView} user={user} handleLogin={handleLogin} />

      <main className="flex-grow">
        {view === 'home' && <HomeView setView={setView} />}
        {view === 'profile' && <ProfileView />}
        {view === 'talent' && <TalentView />}
        {view === 'publications' && <PublicationsView papers={papers} loading={loading} />}
        {view === 'admin' && (
          <AdminDashboard 
            papers={papers} 
            loading={loading} 
            onAdd={handleAddPaper} 
            onDelete={handleDeletePaper} 
          />
        )}
      </main>

      <footer className="bg-slate-900 text-slate-400 py-12 text-sm">
        <div className="max-w-7xl mx-auto px-4 grid md:grid-cols-3 gap-8">
          <div>
            <h4 className="text-white font-bold text-lg mb-4">联系方式</h4>
            <p className="flex items-start gap-2 mb-2">
              <MapPin className="w-4 h-4 mt-1 flex-shrink-0" />
              <span>吉林省长春市人民大街5988号<br/>吉林大学南岭校区汽车工程大楼505</span>
            </p>
            <p className="flex items-center gap-2">
               <Mail className="w-4 h-4" />
               <a href="mailto:wjn@jlu.edu.cn" className="hover:text-white">wjn@jlu.edu.cn</a>
            </p>
          </div>
          <div>
            <h4 className="text-white font-bold text-lg mb-4">快速导航</h4>
            <ul className="space-y-2">
              <li className="hover:text-white cursor-pointer" onClick={() => setView('profile')}>负责人简介</li>
              <li className="hover:text-white cursor-pointer" onClick={() => setView('publications')}>学术成果</li>
              <li className="hover:text-white cursor-pointer" onClick={() => setView('talent')}>人才培养</li>
            </ul>
          </div>
           <div>
            <h4 className="text-white font-bold text-lg mb-4">关于我们</h4>
            <p className="leading-relaxed">
              吉林大学汽车工程学院王军年教授课题组，致力于电动汽车智能化底盘、能量管理及动力传动系统的创新研究。
            </p>
          </div>
        </div>
        <div className="text-center mt-12 pt-8 border-t border-slate-800">
          © {new Date().getFullYear()} Jilin University - NextGen Vehicle Lab. All rights reserved.
        </div>
      </footer>
    </div>
  );
}